# Настройка почты Timeweb для RUNA (коды на email)

Почта **noreply@runafinance.online** на хостинге Timeweb используется для отправки кодов подтверждения регистрации и сброса пароля.

---

## Шаг 1. Создать почтовый ящик в Timeweb

1. Войдите в панель **Timeweb** (timeweb.cloud или timeweb.com).
2. В левом меню нажмите **«Почта»** (иконка конверта).
3. Выберите домен **runafinance.online** (если попросят).
4. Нажмите **«Создать почтовый ящик»** / **«Добавить ящик»**.
5. Укажите:
   - **Логин (часть до @):** `noreply`  
     Итоговый адрес: **noreply@runafinance.online**
   - **Пароль:** придумайте надёжный пароль и сохраните его (понадобится для `.env`).
6. Сохраните ящик.

---

## Шаг 2. Настройки SMTP Timeweb

Для **отправки** писем используется только **SMTP**. POP3 и IMAP — для приёма почты в программу, в бэкенде не нужны.

| Параметр   | Значение |
|-----------|----------|
| **Сервер (SMTP)** | `smtp.timeweb.ru` |
| **Порт**         | **465** (SSL, рекомендуется) или **2525** (без SSL) |
| **Логин**        | полный email: `noreply@runafinance.online` |
| **Пароль**       | пароль от ящика (из шага 1) |

POP3/IMAP (для справки, в .env не добавлять):
- pop3.timeweb.ru — приём по POP3
- imap.timeweb.ru — приём по IMAP

Подробнее: [Настройка почтовых клиентов Timeweb](https://timeweb.cloud/docs/mail/configuring-email-clients) или [Отправка почты через SMTP](https://timeweb.cloud/docs/cms/otpravka-pochty-cherez-smtp).

**Про «Настройки почтового ящика» в Timeweb:**  
В разделе **Настройки** ящика noreply@runafinance.online пункты «Пересылка входящих» и «Пересылка исходящих» **включать не обязательно**. Они нужны только если вы хотите пересылать копии писем на другой адрес. Отправка кодов из приложения идёт по SMTP (логин + пароль ящика), для этого достаточно создать ящик и прописать данные в `.env` (шаг 3).

---

## Шаг 3. Добавить переменные в .env бэкенда

На сервере (или локально в папке `backend-runa`) откройте файл **`.env`** и добавьте:

```env
# SMTP Timeweb — почта noreply@runafinance.online
SMTP_HOST=smtp.timeweb.ru
SMTP_PORT=465
SMTP_USER=noreply@runafinance.online
SMTP_PASS=ваш_пароль_от_ящика
SMTP_FROM=noreply@runafinance.online
```

- **SMTP_PASS** — пароль, который вы задали при создании ящика (шаг 1). Если в пароле есть символы `#` или `=`, укажите в кавычках: `SMTP_PASS="ваш_пароль"`.
- **SMTP_FROM** — можно не указывать, тогда будет использоваться **SMTP_USER**. В письмах отображаемое имя отправителя задаётся в коде бэкенда как **«Runa Finance»** (вместо просто «noreply»).

После сохранения `.env` **обязательно перезапустите бэкенд** (Docker: пересоберите/перезапустите контейнер).

**Как понять, что отправка сработала:** в логах бэкенда при успешной отправке появится строка вида `Email sent to user@example.com (registration)`. Если видите `Failed to send email` — смотрите пункты 2–8 в разделе «Если письма не приходят».

**База данных.** Для хранения кодов подтверждения нужна таблица `email_verification_codes`. Примените схему Prisma: `npx prisma db push` (разработка) или `npx prisma migrate deploy` (если используете миграции).

---

## Шаг 4. Проверка

Когда в приложении будут включены эндпоинты «отправить код на почту» (регистрация / забыл пароль), запрос на отправку кода должен уходить на бэкенд, а письмо — приходить на указанный пользователем email.

Если письма не приходят:

1. **На сервере (VPS)** в папке бэкенда должен быть файл **`.env`** с переменными SMTP (см. шаг 3). Без них в production API вернёт ошибку при отправке кода.
2. В логах бэкенда: сообщение **«SMTP not configured»** — добавьте SMTP_HOST, SMTP_USER, SMTP_PASS в `.env` на сервере и перезапустите контейнер/процесс.
3. В логах **«Failed to send email»** — проверьте пароль ящика, порт 465 и что ящик noreply@runafinance.online создан в Timeweb.
4. Проверьте папку **«Спам»** у получателя.
5. В панели Timeweb → **Почта** посмотрите логи отправки (если есть).
6. Убедитесь, что в `.env` нет лишних пробелов и кавычек вокруг пароля.
7. **Время:** иногда после создания ящика первое письмо уходит с задержкой 2–5 минут; после смены пароля подождите пару минут и перезапустите бэкенд.
8. Если порт **465** не срабатывает (ошибка в логах при отправке), попробуйте в `.env`: `SMTP_PORT=2525` (без SSL). Перезапустите бэкенд.

---

## Письма не приходят даже при ручной отправке с ящика Timeweb

Если вы отправляете письмо вручную из панели Timeweb (или с почтового клиента) с **noreply@runafinance.online** на другой адрес, но оно не доходит — проверьте по порядку:

1. **Папка «Спам» / «Нежелательная почта»** у получателя — очень часто письма с новых ящиков попадают туда. Отметьте «Не спам» и добавьте отправителя в контакты.

2. **Куда отправляете:** попробуйте отправить на **другой почтовый сервис** (например, с Gmail на Яндекс или наоборот). Если на один ящик не приходит, а на другой приходит — блокирует или отфильтровывает именно сервер получателя.

3. **В панели Timeweb:** раздел **Почта** → ваш домен **runafinance.online** → посмотрите, есть ли **«Исходящие»**, **«Очередь»** или **«Логи»**. Там может быть видно: письмо ушло с сервера или вернулось с ошибкой (например, «rejected», «deferred»).

4. **DNS домена runafinance.online:** для доставки почты у домена должны быть настроены записи **SPF** и по возможности **DKIM**. В Timeweb при подключении почты к домену их обычно создают автоматически. Проверьте в разделе **«Домены и SSL»** → **runafinance.online** → **DNS / Записи**: есть ли запись типа **TXT** с `v=spf1` (SPF) и настройки для почты. Если записей нет — в справке Timeweb найдите, как включить почту для домена и добавить SPF.

5. **Время доставки:** некоторые сервисы (Gmail, Mail.ru и др.) задерживают письма от новых отправителей на 10–30 минут. Подождите 15–30 минут и снова проверьте «Входящие» и «Спам».

6. **Ящик только что создан:** у части хостингов первый час после создания ящика действуют ограничения. Подождите 1 час и повторите отправку.

7. **Поддержка Timeweb:** если ничего не помогло, в панели откройте **«Помощь»** / **«Поддержка»** и напишите: «Письма с ящика noreply@runafinance.online не доходят до получателя (проверил Спам, отправлял вручную). Подскажите, всё ли в порядке с отправкой для домена runafinance.online?» Они могут подсказать по логам и настройкам DNS.

---

## Письма в «Отправленные», но не приходят (даже не в Спаме)

Если в Timeweb Mail письма лежат в **«Отправленные»**, но у получателя их нет (и в Спаме тоже нет) — почтовый сервер получателя, скорее всего, **отклоняет** письма от вашего домена. Чаще всего причина — **нет или неправильно настроены SPF и DKIM** для домена **runafinance.online**.

**Что сделать:**

1. **SPF-запись для домена**  
   В панели Timeweb: **Домены и SSL** → выберите **runafinance.online** → **DNS / Управление зоной**.  
   Проверьте, есть ли **TXT-запись** с текстом вида `v=spf1 ...` (SPF).  
   - Если записи нет — в справке Timeweb найдите раздел про **настройку почты для домена** или **SPF для почты** и добавьте рекомендуемую TXT-запись для вашего домена.  
   - Если SPF есть, но письма всё равно не доходят — пришлите эту запись в поддержку Timeweb и спросите, подходит ли она для отправки с их серверов.

2. **DKIM (если есть в Timeweb)**  
   В разделе **Почта** или настройках ящика/домена посмотрите, есть ли включение **DKIM**. Если да — включите и сохраните предложенные DNS-записи (обычно TXT). Это повышает доверие к письмам и улучшает доставку.

3. **Поддержка Timeweb**  
   Напишите в поддержку: «Письма с noreply@runafinance.online отображаются в «Отправленные», но не доходят до получателя (Спам проверен). Подскажите, корректно ли настроены SPF/DKIM для runafinance.online и не блокируются ли письма на вашей стороне? Можете проверить по логам доставки?»  
   Они могут проверить логи отказов (bounce) и сказать, почему письма не принимают.

4. **Проверка доставки**  
   Отправьте тестовое письмо с **noreply@runafinance.online** на свой **Gmail** или **Яндекс** и подождите 15–30 минут. Проверьте «Входящие» и «Спам». Если и туда не приходит — проблема в настройках домена (SPF/DKIM) или в политике Timeweb; поддержка подскажет точнее после проверки логов.

---

## Домен заведён на Cloudflare (или TurboFlare) — NS у Cloudflare

Если у домена **runafinance.online** в регистраторе прописаны **NS-серверы Cloudflare** (или другого DNS-провайдера вроде TurboFlare), то для всего интернета используются **только те DNS-записи, которые заданы в панели Cloudflare**, а не в Timeweb.

То, что вы видите в Timeweb в разделе «DNS», в таком случае может **не использоваться** для доставки почты: почтовые серверы получателя смотрят зону у того, на кого указывают NS (Cloudflare). Если в **Cloudflare DNS** нет нужных записей для почты или они другие — письма не доходят или попадают в спам.

**Что сделать:**

1. Зайдите в панель **Cloudflare** (или TurboFlare) → выберите домен **runafinance.online** → раздел **DNS** (Records).
2. Проверьте, что там есть **те же** записи для почты:
   - **MX** для `runafinance.online`: приоритет 10 — `mx1.timeweb.ru`, приоритет 20 — `mx2.timeweb.ru`.
   - **TXT** для `runafinance.online` (SPF): `v=spf1 include:_spf.timeweb.ru -all`
   - **TXT** для `_dmarc.runafinance.online` (DMARC): `v=DMARC1; p=none;`
   - **TXT** для DKIM — имя хоста и значение должны **совпадать** с тем, что выдал Timeweb при настройке DKIM для ящика (обычно что-то вроде `dkim._domainkey` или подобное, и длинное значение с ключом).
3. Если каких-то записей нет — добавьте их в Cloudflare (тип и значение как в Timeweb). Если DKIM в Timeweb генерируется автоматически, скопируйте точное имя и значение из панели Timeweb в Cloudflare.
4. После сохранения подождите 10–15 минут (TTL) и снова отправьте тестовое письмо.

Если NS у Cloudflare, а MX/SPF/DKIM были только в Timeweb — после добавления этих записей в Cloudflare доставка часто восстанавливается.

---

## Где найти DKIM в панели Timeweb

Запись DKIM **не находится** в разделе «Почта» и не в настройках ящика. По документации Timeweb Cloud значения SPF и DKIM для домена показываются в разделе **«Домены»**:

1. Войдите в панель **Timeweb Cloud** (timeweb.cloud).
2. В левом меню откройте **«Домены»** (иконка глобуса / Domains).
3. Выберите домен **runafinance.online**.
4. Откройте **«DNS-записи»** (или нажмите шестерёнку у домена → настройки DNS / управление зоной).
5. В списке TXT-записей найдите запись для DKIM (имя часто вида `dkim._domainkey` или `selector._domainkey`; значение — длинная строка `k=rsa;p=MIIBIjAN...`). Скопируйте **имя (хост)** и **значение** — их нужно добавить в TurboFlare как TXT.

Если в списке DNS в Timeweb записей DKIM нет (например, NS домена уже указывают на TurboFlare и зона управляется там), в разделе «Домены» иногда есть подсказки или «Рекомендуемые записи» для почты — там может быть показан пример DKIM. Иначе можно написать в поддержку Timeweb: «Подскажите, пожалуйста, имя и значение TXT-записи DKIM для отправки почты с домена runafinance.online (ящик noreply@runafinance.online), чтобы добавить её в DNS у текущего держателя NS».

---

## Что добавить в TurboFlare (если NS у trbcdn.net)

В панели **TurboFlare** у домена **runafinance.online** в разделе **«Наборы записей»** нажмите **«Добавить набор записей»** и создайте по очереди:

**1. MX — почтовые серверы (2 записи)**

| Тип | Имя/хост | Значение | Приоритет | TTL |
|-----|----------|----------|-----------|-----|
| MX  | `runafinance.online` или `@` | `mx1.timeweb.ru` | 10 | 3600 |
| MX  | `runafinance.online` или `@` | `mx2.timeweb.ru` | 20 | 3600 |

(Если в TurboFlare «Имя» оставляют пустым для корня домена — тогда одна запись с именем корня; уточните по подсказкам в форме.)

**2. TXT — SPF (разрешение отправки через Timeweb)**

| Тип | Имя/хост | Значение | TTL |
|-----|----------|----------|-----|
| TXT | `runafinance.online` или `@` | `v=spf1 include:_spf.timeweb.ru -all` | 3600 |

**3. TXT — DMARC (политика проверки писем)**

| Тип | Имя/хост | Значение | TTL |
|-----|----------|----------|-----|
| TXT | `_dmarc.runafinance.online` или `_dmarc` | `v=DMARC1; p=none;` | 3600 |

**4. TXT — DKIM (подпись писем)**

Точное **имя** и **значение** DKIM берутся **не** из раздела «Почта», а из раздела **«Домены»** в панели Timeweb:

1. Войдите в панель **Timeweb Cloud** (timeweb.cloud).
2. В левом меню откройте **«Домены»** (не «Почта»).
3. Выберите домен **runafinance.online**.
4. Перейдите в **«DNS-записи»** (или нажмите на шестерёнку у домена → настройки DNS).
5. В списке записей найдите **TXT** с именем/хостом для DKIM (часто `dkim._domainkey` или похожее) и **скопируйте имя и значение**.
   - Если отдельной записи DKIM нет — в той же зоне посмотрите блок «Рекомендуемые записи» или подсказки по почте; при создании ящика Timeweb автоматически добавляет SPF и DKIM в DNS домена. Если NS у домена сейчас указывают на TurboFlare, в Timeweb эти записи могут быть только «для справки» — скопируйте оттуда имя и значение и создайте такую же TXT в TurboFlare.

Создайте в TurboFlare запись **TXT** с тем же именем и тем же значением (скопируйте из Timeweb без изменений).

После сохранения подождите 15–60 минут (учёт TTL) и снова отправьте тестовое письмо с noreply@runafinance.online.

---

## Отображаемое имя и фото отправителя

**Имя отправителя (Runa Finance вместо noreply):**  
В коде бэкенда письма отправляются с полем **From** в формате `Runa Finance <noreply@runafinance.online>`. В почтовом клиенте получателя будет видно **«Runa Finance»** (или «Runa Finance <noreply@runafinance.online>»), а не только «noreply». Ничего дополнительно в Timeweb настраивать не нужно — достаточно перезапустить бэкенд после обновления кода.

**Фото/аватар отправителя:**  
Стандартный SMTP не передаёт картинку отправителя. Как клиенты показывают аватар:

- **Gmail:** в списке писем показывает первую букву имени в кружке (после смены имени будет «R» от Runa Finance). Чтобы у получателя отображалась ваша картинка, он может добавить контакт «Runa Finance» / noreply@runafinance.online в контакты и задать фото — тогда Gmail подставит его.
- **Gravatar:** многие почтовые клиенты (не Gmail в списке) подставляют аватар с [gravatar.com](https://gravatar.com). Если зарегистрировать на Gravatar адрес **noreply@runafinance.online** и привязать к нему логотип RUNA, в поддерживающих Gravatar клиентах будет отображаться это изображение. Регистрация: Gravatar → Sign in → добавить email noreply@runafinance.online → загрузить изображение.

---

## Кратко

1. **Timeweb** → **Почта** → создать ящик **noreply@runafinance.online**, сохранить пароль.
2. В **`.env`** бэкенда (на вашем компьютере и **на сервере VPS**) прописать **SMTP_HOST**, **SMTP_PORT**, **SMTP_USER**, **SMTP_PASS** (и при желании **SMTP_FROM**).
3. На сервере выполнить: `npx prisma db push` (чтобы появилась таблица `email_verification_codes`).
4. Перезапустить бэкенд на сервере.

После этого модуль отправки писем (EmailService) сможет отправлять коды через Timeweb. В приложении уже реализованы: после регистрации — экран с 6 окошками для кода и «Отправить повторно» (через 3 мин); при «Забыл пароль» — ввод email → 6 цифр → экран «Новый пароль» с логотипом RUNA сверху.

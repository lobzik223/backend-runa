# AI Chat Architecture

## Overview

AI Chat –º–æ–¥—É–ª—å –¥–ª—è RUNA Finance –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: **–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Å—Ç–∏—á–µ—Å–∫–∏–π rules engine** + **LLM –¥–ª—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫**.

## Architecture

```
User Message
    ‚Üì
Safety Guardrails (validate risky requests)
    ‚Üì
Finance Context Service (gather user data)
    ‚Üì
Rules Engine (deterministic analysis)
    ‚Üì
Structured Outputs (insights, warnings, plans)
    ‚Üì
LLM Service (natural language generation)
    ‚Üì
Response to User
```

## Components

### 1. FinanceContextService

–°–æ–±–∏—Ä–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –î–æ—Ö–æ–¥—ã/—Ä–∞—Å—Ö–æ–¥—ã —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
- –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤/–¥–æ—Ö–æ–¥–æ–≤
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ü–µ–ª—è–º
- –°—Ç–∞—Ç—É—Å –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö —Å—á–µ—Ç–æ–≤
- –ü–æ—Ä—Ç—Ñ–µ–ª—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
- –ù–æ—Ä–º–∞ —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π

### 2. AIRulesEngineService

–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –¥–≤–∏–∂–æ–∫ –ø—Ä–∞–≤–∏–ª, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã:

**–ü—Ä–∞–≤–∏–ª–∞:**
1. **–î–µ—Ñ–∏—Ü–∏—Ç –±—é–¥–∂–µ—Ç–∞** - –µ—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥—ã > –¥–æ—Ö–æ–¥—ã
2. **–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º** - –µ—Å–ª–∏ –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è > 40% —Ä–∞—Å—Ö–æ–¥–æ–≤
3. **–ù–∏–∑–∫–∞—è –Ω–æ—Ä–º–∞ —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π** - –µ—Å–ª–∏ < 10%
4. **–ö—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã** - –≤–Ω–µ–∑–∞–ø–Ω—ã–µ –±–æ–ª—å—à–∏–µ —Ä–∞—Å—Ö–æ–¥—ã
5. **–ù–µ–¥–æ—Å—Ç–∏–∂–∏–º—ã–µ —Ü–µ–ª–∏** - –µ—Å–ª–∏ –Ω—É–∂–Ω–∞—è —Å—É–º–º–∞ > –¥–æ—Å—Ç—É–ø–Ω–æ–π
6. **–í—ã—Å–æ–∫–∏–π –¥–æ–ª–≥** - –µ—Å–ª–∏ –¥–æ–ª–≥ > 50% –¥–æ—Ö–æ–¥–∞
7. **–ó–∞–ø—Ä–æ—Å—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤** - –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
8. **–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π** - –Ω–∞ 1, 3, 6 –º–µ—Å—è—Ü–µ–≤

**–¢–∏–ø—ã –≤—ã–≤–æ–¥–æ–≤:**
- `insight` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
- `warning` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- `plan` - –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π
- `chart_request` - –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é

### 3. LLMService

–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã –≤ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫.

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- Guardrails –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã: "–∫—É–ø–∏ –∞–∫—Ü–∏–∏", "–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å", "100% –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å"

**–†–µ–∂–∏–º—ã:**
- **Stub mode** (–±–µ–∑ API –∫–ª—é—á–∞): —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã
- **LLM mode** (—Å API –∫–ª—é—á–æ–º): Grok (xAI) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî OpenAI

### 4. AIChatService

–û—Ä–∫–µ—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å:
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ (Free: 10/–¥–µ–Ω—å, Premium: 1000/–¥–µ–Ω—å)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ë–î
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ threads

## API Endpoints

### POST /api/ai/chat
```json
{
  "message": "–ö–∞–∫ –¥–µ–ª–∞ —Å –º–æ–∏–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏?",
  "threadId": "optional-thread-id"
}
```

**Response:**
```json
{
  "message": "–ê–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤...",
  "structuredOutputs": [
    {
      "type": "warning",
      "payload": {
        "title": "–î–µ—Ñ–∏—Ü–∏—Ç –±—é–¥–∂–µ—Ç–∞",
        "description": "...",
        "severity": "critical",
        "suggestions": [...]
      }
    }
  ],
  "threadId": "uuid",
  "messageId": "uuid"
}
```

### GET /api/ai/threads
–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö threads –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### GET /api/ai/threads/:id
–ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ thread

## Safety Guardrails

AI **–ù–ï –¥–∞–µ—Ç**:
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ì–∞—Ä–∞–Ω—Ç–∏–∏ –ø—Ä–∏–±—ã–ª–∏
- –°–æ–≤–µ—Ç—ã –ø–æ –ø–æ–∫—É–ø–∫–µ/–ø—Ä–æ–¥–∞–∂–µ –∞–∫—Ü–∏–π

AI **–¥–∞–µ—Ç**:
- –ê–Ω–∞–ª–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
- –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –±—é–¥–∂–µ—Ç–æ–º
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ä–∏—Å–∫–∞—Ö

## Message Limits

- **Free tier**: 10 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å
- **Premium tier**: 1000 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑–ª–∏–º–∏—Ç)

## Database Schema

### AiThread
- `id` (UUID)
- `userId`
- `title` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `createdAt`, `updatedAt`

### AiMessage
- `id` (UUID)
- `userId`
- `threadId`
- `role` (USER | ASSISTANT | SYSTEM | TOOL)
- `content`
- `model` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
- `tokensIn`, `tokensOut` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `createdAt`

## Integration with Grok (xAI)

–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è LLM:

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `GROK_API_KEY` –≤ `.env` (–∫–ª—é—á –ø–æ–ª—É—á–∏—Ç—å: https://console.x.ai/team/default/api-keys)
2. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: `OPENAI_API_KEY` –∏ `OPENAI_MODEL` ‚Äî –∑–∞–ø–∞—Å–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä

```env
GROK_API_KEY=xai-...
# –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini
```

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Grok ‚Üí OpenAI ‚Üí stub. –ë–µ–∑ –∫–ª—é—á–µ–π —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ stub —Ä–µ–∂–∏–º–µ.

## Example Prompts

**User:** "–ö–∞–∫ –¥–µ–ª–∞ —Å –º–æ–∏–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏?"

**Rules Engine Output:**
```json
[
  {
    "type": "warning",
    "payload": {
      "title": "–î–µ—Ñ–∏—Ü–∏—Ç –±—é–¥–∂–µ—Ç–∞",
      "description": "–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã –Ω–∞ 5 000 ‚ÇΩ",
      "severity": "critical"
    }
  }
]
```

**LLM Response:**
"üìä –î–µ—Ñ–∏—Ü–∏—Ç –±—é–¥–∂–µ—Ç–∞

–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã –Ω–∞ 5 000 ‚ÇΩ. –†–µ–∫–æ–º–µ–Ω–¥—É—é –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫—Ä—É–ø–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∏ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã."
